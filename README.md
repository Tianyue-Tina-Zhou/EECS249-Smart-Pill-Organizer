# EECS249-Smart-Pill-Organizer
This repo contains the implementation of a smart pill organizer using LF and C on a Raspberry Pi Pico board

## Build & Run

### 1. Pull and Update The Submodules

There are two submodules currently:
- `lingua-franca`: This is the source code repo for Lingua Franca. We are NOT using this when building, this submodule is solely for reference when writing the code.
- `pico-sdk`: This is the Pico C/C++ SDK repo. This is necessary for building code into PICO executable.

```
git pull
git submodule update --init --recursive
```
Note that this may take a while for the first time, as `pico-sdk` has its own submodules and we need to fetch all of them recursively.

### 2. Build

A build script for MacOS (I have no access to Windows computers) is there for convenience. To run the script:

```
cd product
./build.sh
```
Once the script finishes execution, the build folder will be opened in Finder.

This build script does the follow:
1. Clean up the build directory, delete any temporary files generated by previous build
2. Build `.lf` codes into `.c` codes by calling the `lfc` command, which is located at `../lfc/bin/run/lfc`. Current version of lfc is from the nightly release downloaded from https://github.com/lf-lang/lingua-franca/releases/tag/nightly.
3. Copy `waveshare` hardware support files.
4. Replace the platform support files with Pico-specific files. For convenience, we are replacing the entire `core` folder right now. 
5. Replace the `CMakeLists.txt` file with our own version, as we need to include Pico-SDK.
6. Build the Pico executable `.uf2` file with `cmake` and `make`.
7. Open the build directory

For Windows, you may write a similar script, or run the command manually. 

### 3. Run on Pico
Connect Pico while pressing the `BOOTSEL` button on chip. It will be recognized as a hard disk. Copy `SPO.uf2` in the build folder into the disk. Pico will disconnect and restart automatically. After restart, the updated codes will be run.

## Notes
1. A very rough demo is included, which will blink the on-board LED.
2. ~~Currently the demo code is not run properly, I suspect it is because clock support is not yet implemented. Once that is done, the demo code should work. I tried getting rid of `#include "core/reactor.c"` in the generated `Main.c` file, include a `main` function, and call the generated `mainreaction_function_0` directly, it works well on Pico. So I guess the building procedure is fine. We shall revisit this if the issue still exists after clock support is done.~~ This issue has been fixed: it turns out it's not the clock issue. The `argc` provided on Pico is fed with `Int32.Max`, which is 2^ 31 - 1. In `reactor_common.c`, function `process_args`, there's a iteration from `1` until `argc`. This iteration blocks the process for extremely large `argc`. To fix, we hardcode `argc` to be `0` and `argv` to be `NULL`. This is fine because there's no CMD interface on PICO, and no arguments shall be passed through `argc` and `argv`.
3. All Pico related support files are in the `product/lib-support/core/platform/` folder, including both clock and thread support files. The basic function signature is provided in the template, but no implementation yet.
4. We probably need to change `lf_tag_64_32.h` as Pico's rp2040 processor is 32 bit instead of 64 bit.
5. I changed `product/lib-support/core/platform.h` to remove platform checking, it will reference to `lf_pico_support.h` directly.
6. All other files in `product/lib-support/core/` is not modified, except the ones in `platform` folder, `platform.h`, and 'reactor.c'.
7. In the original Lingua Franca repo, these support files are located at https://github.com/lf-lang/reactor-c/tree/e82c413d2f005901c8efe33df3b45762bb79451c/core

